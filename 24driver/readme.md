24 Drive
========

PID control for 24 DC motor channels, with position, current, and pressure sensor feedback.

Features
--------

* 24 DC motor drives; PWM control @ 97kHz.
* 24 Potentiometer inputs.
* PID control loop at 69Hz.
* 24 Motor current inputs, measured from 0.1ohm shunt sensors.
* 12 Strain gauge inputs.
* Soft power-on via button.
* Power measuring. Voltage measured with onboard ADC, current measured through hall effect sensor.
* OLED display.
* I2C connections.
* WiFi.
* Inertial measurement unit.
* Maximum 24V, 10A continuous total, and 2A per channel (internally limited).
* Minimum 6.5V, with auto turn-off feature for low battery voltage (under 6.7V).


Functional Description
----------------------

The chip controls 24 [DRV8870DDAR] motor drivers, using 2 PWM inputs each at 97kHz. The PWM signals
are generated by [TLC59116IPWR] LED current sink drivers, with the outputs pulled high (inverted logic).
Positions are measured by potentiometers for each channel. The potentiometers plug into [ADC128S102]
and are powered by 5V. We can thus achieve PID control for each channel, turning DC motors into servos.
Get current feedback from the motor drivers by a 0.1ohm sense resistor connected to [AD7689BCPZRL7]
referenced to 1V through a voltage divider.

Separate to the motor driver units, there is power monitoring. Voltage through a resistive divider
and current via a [ACS712-20A-T] hall effect sensor. And a soft-touch power-on that uses minimal
current drain when off. The chip turns off under 6.7V from the battery; the safety threshold for
2S LiPo.

There is an OLED display [SSD1306] that flashes power info and WiFi connection status.

6 exposed pins including GPIO 0 (bootloader pin) as well as secondary I2C interface (the first I2C
line controls component ICs).

12 Wheatstone bridges that are usually used for strain gauges. The gauges are connected to [ADS1115]
with the 4th input set as reference to half the gauge driving voltage of 3.3V.

Gyro and acceleration measurements via [MPU-6050] connected on the first I2C line.

Communication with the components is done via the first I2C line for the display, pressure sensors,
gyro, and PWM controls. Serial interface for position and current measurements.

External interface via WiFi; with a websocket API. Wired interface possible through I2C, or USB connection,
but not yet implemented.

Main copper power line has width enough to dissipate 10A continuously. And each motor driver has a
cutoff set to 2A per. The minimum voltage for the motor drivers is 6.5V and the ESP32 can be powered
at 5V from USB, and 6.1V from the 5V voltage regulator with a 1.1V dropout voltage. The maximum voltage
for the components on the motor power line are, in descending order, 45V for the motor driver, 35V for
the voltage regulator, 30V for the power mosfet, and 25V for the power bank capacitors. Thus I set the
maximum usable voltage at 24V.



[DRV8870DDAR]: https://www.ti.com/lit/ds/symlink/drv8870.pdf
[TLC59116IPWR]: https://www.ti.com/lit/ds/symlink/tlc59116.pdf
[ADC128S102]: https://www.ti.com/lit/ds/symlink/adc128s102.pdf
[ACS712-20A-T]: https://www.sparkfun.com/datasheets/BreakoutBoards/0712.pdf
[AD7689BCPZRL7]: https://www.analog.com/media/en/technical-documentation/data-sheets/AD7682_7689.pdf
[SSD1306]: https://cdn-shop.adafruit.com/datasheets/SSD1306.pdf
[ADS1115]: https://www.ti.com/lit/ds/symlink/ads1115.pdf
[MPU-6050]: https://www.invensense.com/wp-content/uploads/2015/02/MPU-6000-Datasheet1.pdf


Layout
------

* main: C++ code for the driver.
* web: HTML & JS code for the web app.
* PCB: Circuit board design files.
* build: Build location, ignored by git.
* components: Required dependencies, installed as git subcomponents or just copied.


Setup
-----

* [esp-idf-v3.2.3](https://github.com/espressif/esp-idf/releases/tag/v3.2.3) install via the esp tools installer.
* [arduino-esp32-v1.0.4](https://github.com/espressif/arduino-esp32/releases/tag/1.0.4) install from readme instructions.
* [Adafruit_SSD1306](https://github.com/adafruit/Adafruit_SSD1306), extract to `components/arduino/libraries`.
* [Adafruit-GFX-Library](https://github.com/adafruit/Adafruit-GFX-Library), extract to `components/arduino/libraries`.
* [ESPAsyncWebServer](https://github.com/me-no-dev/ESPAsyncWebServer), extract to `components`.
* [AsyncTCP](https://github.com/me-no-dev/AsyncTCP), extract to `components`.
* Make sure to configure AsyncTCP to run on core 0.
* Also configure CONFIG_ARDUINO_EVENT_RUNNING_CORE for core 0. This is used by the WiFi library.
* Install [node js v13 and npm](https://nodejs.org/en/), and update local packages with `npm install`.
* Build with webpack (we need it to tree-shake d3 so we don't include the entire lib) by running `npm run build`.
* Install [mkspiffs](https://github.com/igrr/mkspiffs/releases/download/0.2.3/mkspiffs-0.2.3-arduino-esp32-win32.zip) (or use esp-idf v4's spiffsgen.py tool), and run command to create the spiffs image: `mkspiffs -c web/dist -b 4096 -p 256 -s 0x30000 build/spiffs.bin`.
* Install [esptool](https://github.com/espressif/esptool) and run command to upload web page to flash/spiffs: `python -m esptool --chip esp32 --port COM3 --baud 115200 write_flash -z 0x110000 build/spiffs.bin`.
